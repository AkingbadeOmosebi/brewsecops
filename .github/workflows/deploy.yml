name: Deploy Infrastructure

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  TERRAFORM_VERSION: 1.5.0
  TF_IN_AUTOMATION: true

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  terraform-lint:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    needs: [gitleaks-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Terraform Format
        run: terraform fmt -check -recursive infra/terraform/
        continue-on-error: false

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: [terraform-lint]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Initialize Terraform
        run: |
          cd infra/terraform/environments/dev
          terraform init -backend=false
      - name: Validate Configuration
        run: |
          cd infra/terraform/environments/dev
          terraform validate

  trivy-scan:
    name: Trivy Infrastructure Scan
    runs-on: ubuntu-latest
    needs: [terraform-lint]
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: infra/terraform/
          format: table
        continue-on-error: true

  checkov-scan:
    name: Checkov Compliance Scan
    runs-on: ubuntu-latest
    needs: [terraform-lint]
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infra/terraform/
          framework: terraform
          quiet: false
          soft_fail: true
        continue-on-error: true

  infracost-estimate:
    name: Infrastructure Cost Estimation
    runs-on: ubuntu-latest
    needs: [terraform-validate, trivy-scan, checkov-scan]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
      - name: Generate Cost Estimate
        run: |
          cd infra/terraform/environments/dev
          infracost breakdown --path . \
            --format json \
            --out-file /tmp/infracost.json
      - name: Upload Cost Artifact
        uses: actions/upload-artifact@v4
        with:
          name: infracost-estimate
          path: /tmp/infracost.json
          retention-days: 7
      - name: Post Cost Summary
        run: |
          echo "## ðŸ’° Infrastructure Cost Estimate" >> $GITHUB_STEP_SUMMARY
          infracost output --path /tmp/infracost.json --format table >> $GITHUB_STEP_SUMMARY

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [infracost-estimate]
    permissions:
      contents: read
      id-token: write
    outputs:
      plan_exit_code: ${{ steps.plan.outputs.exit_code }}
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
          
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV      

      - name: Initialize Terraform
        run: |
          cd infra/terraform/environments/dev
          terraform init
      - name: Generate Plan
        id: plan
        run: |
          cd infra/terraform/environments/dev
          terraform plan -out=tfplan -no-color
          echo "exit_code=0" >> $GITHUB_OUTPUT
        continue-on-error: true
      - name: Save Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/environments/dev/tfplan
          retention-days: 1

  approval-gate:
    name: Approval Gate
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    environment:
      name: production
    steps:
      - name: Waiting for Approval
        run: echo "Deployment approved and ready to proceed"

  deploy-vpc:
    name: Deploy VPC Foundation
    runs-on: ubuntu-latest
    needs: [approval-gate]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy VPC
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.vpc -auto-approve

  deploy-security-groups:
    name: Deploy Security Groups
    runs-on: ubuntu-latest
    needs: [deploy-vpc]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy Security Groups
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.security_groups -auto-approve

  deploy-database:
    name: Deploy RDS Database
    runs-on: ubuntu-latest
    needs: [deploy-security-groups]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy RDS
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.rds -auto-approve

  deploy-compute:
    name: Deploy ECS & Container Infrastructure
    runs-on: ubuntu-latest
    needs: [deploy-database]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy ECS Cluster
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.ecs_cluster -auto-approve
      - name: Deploy ECR Repositories
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.ecr -auto-approve

  deploy-networking:
    name: Deploy ALB & Networking
    runs-on: ubuntu-latest
    needs: [deploy-compute]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy ALB
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.alb -auto-approve

  deploy-dns-ssl:
    name: Deploy DNS & SSL/TLS
    runs-on: ubuntu-latest
    needs: [deploy-networking]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy ACM Certificate
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.acm -auto-approve
      - name: Deploy Route53 DNS
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.route53 -auto-approve

  deploy-waf:
    name: Deploy WAF Protection
    runs-on: ubuntu-latest
    needs: [deploy-dns-ssl]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy WAF
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.waf -auto-approve

  deploy-services:
    name: Deploy ECS Services
    runs-on: ubuntu-latest
    needs: [deploy-waf]
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      - name: Get Secrets from AWS Secrets Manager
        run: |
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id brewsecops/dev/db-password \
            --query SecretString \
            --output text \
            --region eu-central-1)
          echo "TF_VAR_db_master_password=$DB_PASSWORD" >> $GITHUB_ENV
          echo "TF_VAR_domain_name=brewsecops.online" >> $GITHUB_ENV
          echo "TF_VAR_frontend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_backend_image_tag=dev" >> $GITHUB_ENV
          echo "TF_VAR_waf_rate_limit=2000" >> $GITHUB_ENV
          echo "TF_VAR_waf_ip_whitelist=[]" >> $GITHUB_ENV
          echo "TF_VAR_blocked_countries=[\"CN\",\"RU\",\"KP\"]" >> $GITHUB_ENV
          echo "TF_VAR_enable_geo_blocking=true" >> $GITHUB_ENV
      - name: Deploy ECS Services
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform apply -lock=false -target=module.ecs_service_frontend -target=module.ecs_service_backend -auto-approve

  deployment-notification:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-services]
    if: always()
    permissions:
      contents: read
      statuses: write          
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Create Deployment Status
        uses: actions/github-script@v6
        with:
          script: |
            const jobResult = '${{ needs.deploy-services.result }}';
            
            let status, description;
            
            if (jobResult === 'success') {
              status = 'success';
              description = ' Infrastructure deployed successfully';
            } else if (jobResult === 'failure') {
              status = 'failure';
              description = ' Deployment failed - check logs';
            } else if (jobResult === 'skipped') {
              status = 'pending';
              description = ' Deployment skipped';
            } else {
              status = 'error';
              description = ' Unknown deployment status';
            }
            
            console.log(`Posting status: ${status} - ${description}`);
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              description: description,
              context: 'deployment/infrastructure'
            });