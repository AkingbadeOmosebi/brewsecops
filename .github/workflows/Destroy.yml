name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy" to confirm infrastructure deletion'
        required: true

env:
  TERRAFORM_VERSION: 1.5.0
  TF_IN_AUTOMATION: true

jobs:
  # Confirmation check
  confirm-destruction:
    name: Confirm Destruction Intent
    runs-on: ubuntu-latest
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "destroy" ]; then
            echo " Destruction cancelled: confirmation text incorrect"
            exit 1
          fi
          echo " Destruction intent confirmed"

  # Human approval gate before destruction
  approval-gate:
    name: Approval Gate (DESTRUCTIVE)
    runs-on: ubuntu-latest
    needs: [confirm-destruction]
    environment:
      name: production
    steps:
      - name: Awaiting Manual Approval
        run: echo "‚ö†Ô∏è Awaiting manual approval to destroy all infrastructure"

  # Destroy infrastructure in reverse logical order
  destroy-ecs-services:
    name: Destroy ECS Services
    runs-on: ubuntu-latest
    needs: [approval-gate]
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy ECS Services
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.ecs_service_frontend -target=module.ecs_service_backend -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-waf:
    name: Destroy WAF Protection
    runs-on: ubuntu-latest
    needs: [destroy-ecs-services]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy WAF
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.waf -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-dns-ssl:
    name: Destroy DNS & SSL/TLS
    runs-on: ubuntu-latest
    needs: [destroy-waf]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy Route53 DNS
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.route53 -auto-approve
      
      - name: Destroy ACM Certificate
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.acm -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-alb:
    name: Destroy ALB & Networking
    runs-on: ubuntu-latest
    needs: [destroy-dns-ssl]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy ALB
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.alb -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-compute:
    name: Destroy ECS & Container Infrastructure
    runs-on: ubuntu-latest
    needs: [destroy-alb]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy ECR Repositories
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.ecr -auto-approve
      
      - name: Destroy ECS Cluster
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.ecs_cluster -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-database:
    name: Destroy RDS Database
    runs-on: ubuntu-latest
    needs: [destroy-compute]
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy RDS
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.rds -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-security-groups:
    name: Destroy Security Groups
    runs-on: ubuntu-latest
    needs: [destroy-database]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy Security Groups
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.security_groups -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destroy-vpc:
    name: Destroy VPC Foundation
    runs-on: ubuntu-latest
    needs: [destroy-security-groups]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::194722436853:role/github-actions-brewsecops-role
          aws-region: eu-central-1
      
      - name: Destroy VPC
        run: |
          cd infra/terraform/environments/dev
          terraform init
          terraform destroy -target=module.vpc -auto-approve

      - name: Cleanup Stuck Terraform Locks
        if: failure()
        run: |
          cd infra/terraform/environments/dev
          
          echo "üîç Checking for stuck locks..."
          
          LOCK_ID=$(aws dynamodb scan \
            --table-name brewsecops-terraform-locks \
            --query 'Items[0].LockID.S' \
            --output text 2>/dev/null)
          
          if [ ! -z "$LOCK_ID" ] && [ "$LOCK_ID" != "None" ]; then
            echo "üîì Found stuck lock: $LOCK_ID"
            terraform force-unlock "$LOCK_ID" -force
            echo "‚úÖ Lock released successfully"
          else
            echo "‚ú® No stuck locks found"
          fi

  destruction-summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [destroy-vpc]
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Destruction Status
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ needs.destroy-vpc.result }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success' 
              ? '‚úÖ Infrastructure destroyed successfully' 
              : '‚ùå Destruction failed - manual cleanup may be required';
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              description: description,
              context: 'destruction/infrastructure'
            });
            
            console.log(description);
      
      - name: Final Status
        run: |
          echo "Infrastructure Destruction Complete"
          echo "Status: ${{ needs.destroy-vpc.result }}"
          echo "All infrastructure has been removed"